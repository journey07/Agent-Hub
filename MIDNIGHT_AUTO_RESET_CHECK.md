# ìì • ìë™ ë¦¬ì…‹ ìµœì¢… ì²´í¬

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ âœ…

### 1. í”„ë¡ íŠ¸ì—”ë“œ ìì • ê°ì§€
- **ìœ„ì¹˜**: `AgentContext.jsx` - `useEffect` (1ë¶„ë§ˆë‹¤ ì²´í¬)
- **ë™ì‘**: 
  1. í•œêµ­ ì‹œê°„ëŒ€ ê¸°ì¤€ ë‚ ì§œ ì²´í¬
  2. ë‚ ì§œê°€ ë°”ë€Œë©´ â†’ DB ë¦¬ì…‹ í•¨ìˆ˜ í˜¸ì¶œ
  3. ë°ì´í„° ìƒˆë¡œê³ ì¹¨

### 2. DB ì¦‰ì‹œ ë¦¬ì…‹
- **í•¨ìˆ˜**: `reset_today_stats_for_all_agents()` (RPC)
- **í˜¸ì¶œ**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìì • ê°ì§€ ì‹œ ìë™ í˜¸ì¶œ
- **ë™ì‘**: ëª¨ë“  ì—ì´ì „íŠ¸ì˜ `today_api_calls`, `today_tasks`ë¥¼ 0ìœ¼ë¡œ ë¦¬ì…‹

### 3. Realtime ìë™ ì—…ë°ì´íŠ¸
- **ìœ„ì¹˜**: `AgentContext.jsx` - Realtime êµ¬ë…
- **ë™ì‘**: DB ë³€ê²½ ì‹œ WebSocketìœ¼ë¡œ ì¦‰ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ë°˜ì˜

### 4. í”„ë¡ íŠ¸ì—”ë“œ í•„í„°ë§
- **ìœ„ì¹˜**: ëª¨ë“  ë°ì´í„° ì¡°íšŒ ì‹œ
- **ë™ì‘**: ì˜¤ëŠ˜ ë‚ ì§œ ë°ì´í„°ë§Œ í‘œì‹œ

## ì „ì²´ í”Œë¡œìš° (23:59 â†’ 00:01)

### 00:00 (ìì • ë„ë‹¬)

**1. í”„ë¡ íŠ¸ì—”ë“œ ìì • ê°ì§€ (1ë¶„ ì´ë‚´)**
```javascript
// 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
setInterval(() => {
    const currentDate = getTodayInKoreaString(); // '2025-01-16'
    const lastChecked = localStorage.getItem('dashboard_last_checked_date'); // '2025-01-15'
    
    if (lastChecked !== currentDate) {
        // ğŸ¯ ìì • ê°ì§€!
        
        // 1. DB ì¦‰ì‹œ ë¦¬ì…‹
        await supabase.rpc('reset_today_stats_for_all_agents');
        // â†’ ëª¨ë“  today_api_calls = 0
        // â†’ ëª¨ë“  today_tasks = 0
        // â†’ last_reset_date = '2025-01-16'
        
        // 2. Realtime ì´ë²¤íŠ¸ ë°œìƒ
        // â†’ agents í…Œì´ë¸” UPDATE ì´ë²¤íŠ¸
        // â†’ í”„ë¡ íŠ¸ì—”ë“œê°€ ì¦‰ì‹œ ìˆ˜ì‹ 
        
        // 3. ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await refreshAllData();
        // â†’ ì˜¤ëŠ˜ ë‚ ì§œ í•„í„°ë§ ì ìš©
        // â†’ ëª¨ë“  í†µê³„ê°€ 0ìœ¼ë¡œ í‘œì‹œë¨
    }
}, 60000);
```

**2. DB ë¦¬ì…‹ ì‹¤í–‰**
```sql
-- reset_today_stats_for_all_agents() í•¨ìˆ˜ ì‹¤í–‰
UPDATE agents SET 
    today_api_calls = 0,
    today_tasks = 0,
    last_reset_date = '2025-01-16';

UPDATE api_breakdown SET today_count = 0;
```

**3. Realtime ì´ë²¤íŠ¸ ë°œìƒ**
- `agents` í…Œì´ë¸” UPDATE ì´ë²¤íŠ¸
- WebSocketìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œì— ì „ì†¡

**4. í”„ë¡ íŠ¸ì—”ë“œ ìë™ ì—…ë°ì´íŠ¸**
```javascript
.on('postgres_changes', { table: 'agents' }, (payload) => {
    // ì—ì´ì „íŠ¸ í†µê³„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    setAgents(prev => {
        // today_api_calls = 0
        // today_tasks = 0
        // ì°¨íŠ¸ ìë™ ì—…ë°ì´íŠ¸
    });
})
```

### 00:00 ~ 00:01 (ìì • ì§í›„)

**í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ:**
- âœ… ëª¨ë“  `today_api_calls` = 0
- âœ… ëª¨ë“  `today_tasks` = 0
- âœ… ì°¨íŠ¸: ëª¨ë“  ì‹œê°„ì´ 0ìœ¼ë¡œ í‘œì‹œ
- âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ **ë¶ˆí•„ìš”** (Realtimeìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸)

### 00:01 ì´í›„ (ì²« API í˜¸ì¶œ)

**ì—ì´ì „íŠ¸ê°€ API í˜¸ì¶œ:**
```javascript
updateAgentStats('agent-001', 'api_call', ...)
```

**DB í•¨ìˆ˜ ì‹¤í–‰:**
```sql
-- update_agent_stats í•¨ìˆ˜
v_today := '2025-01-16';
v_last_reset_date := '2025-01-16'; -- ì´ë¯¸ ë¦¬ì…‹ë¨

IF v_last_reset_date < v_today THEN
    -- ì´ë¯¸ ë¦¬ì…‹ë˜ì—ˆìœ¼ë¯€ë¡œ ìŠ¤í‚µ
END IF;

-- í†µê³„ ì¦ê°€
UPDATE agents SET today_api_calls = 1 WHERE id = 'agent-001';
```

**Realtime ì—…ë°ì´íŠ¸:**
- `today_api_calls` = 0 â†’ 1
- í”„ë¡ íŠ¸ì—”ë“œì— ì¦‰ì‹œ ë°˜ì˜
- ì°¨íŠ¸ ìë™ ì—…ë°ì´íŠ¸

## í™•ì¸ ì‚¬í•­ âœ…

### âœ… í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì‘ë™í•˜ëŠ”ê°€?

**ì˜ˆ!** ë‹¤ìŒ ì´ìœ ë¡œ ì‘ë™í•©ë‹ˆë‹¤:

1. **DB ë¦¬ì…‹ ì¦‰ì‹œ ì‹¤í–‰**
   - í”„ë¡ íŠ¸ì—”ë“œê°€ ìì • ê°ì§€ ì‹œ `reset_today_stats_for_all_agents()` í˜¸ì¶œ
   - DBê°€ ì¦‰ì‹œ ë¦¬ì…‹ë¨

2. **Realtime ìë™ ì—…ë°ì´íŠ¸**
   - DB ë³€ê²½ ì‹œ WebSocketìœ¼ë¡œ ì¦‰ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ë°˜ì˜
   - `setAgents()` ìë™ í˜¸ì¶œ
   - ì°¨íŠ¸ ìë™ ì—…ë°ì´íŠ¸

3. **ëª…ì‹œì  ìƒˆë¡œê³ ì¹¨**
   - `refreshAllData()` í˜¸ì¶œë¡œ ìµœì‹  ë°ì´í„° í™•ì¸
   - ì˜¤ëŠ˜ ë‚ ì§œ í•„í„°ë§ ì ìš©

### âœ… í•œ ë²ˆì— ì«™ ë°”ë€ŒëŠ”ê°€?

**ì˜ˆ!** ë‹¤ìŒ ìˆœì„œë¡œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤:

1. **00:00** - í”„ë¡ íŠ¸ì—”ë“œ ìì • ê°ì§€ (1ë¶„ ì´ë‚´)
2. **00:00** - DB ë¦¬ì…‹ í•¨ìˆ˜ í˜¸ì¶œ (ì¦‰ì‹œ ì‹¤í–‰)
3. **00:00** - Realtime ì´ë²¤íŠ¸ ë°œìƒ (ì¦‰ì‹œ)
4. **00:00** - í”„ë¡ íŠ¸ì—”ë“œ ìë™ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ)
5. **00:00** - ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ëª…ì‹œì )

**ì „ì²´ ê³¼ì •: 1ë¶„ ì´ë‚´ ì™„ë£Œ**

### âœ… ë¸Œë¼ìš°ì €ê°€ ë‹«í˜€ìˆìœ¼ë©´?

- í”„ë¡ íŠ¸ì—”ë“œ ìì • ê°ì§€ëŠ” ì‘ë™ ì•ˆ í•¨
- í•˜ì§€ë§Œ ë‹¤ìŒ API í˜¸ì¶œ ì‹œ `update_agent_stats` í•¨ìˆ˜ê°€ ë‚ ì§œ ì²´í¬ í›„ ë¦¬ì…‹
- ë¸Œë¼ìš°ì €ë¥¼ ë‹¤ì‹œ ì—´ë©´ ë¦¬ì…‹ëœ ë°ì´í„°ê°€ í‘œì‹œë¨

## ìµœì¢… í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] í”„ë¡ íŠ¸ì—”ë“œ ìì • ê°ì§€ êµ¬í˜„ë¨
- [x] DB ë¦¬ì…‹ í•¨ìˆ˜ í˜¸ì¶œ êµ¬í˜„ë¨
- [x] Realtime ì—…ë°ì´íŠ¸ êµ¬í˜„ë¨
- [x] í”„ë¡ íŠ¸ì—”ë“œ í•„í„°ë§ êµ¬í˜„ë¨
- [x] í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì‘ë™
- [x] í•œ ë²ˆì— ì«™ ë°”ë€œ (1ë¶„ ì´ë‚´)

## í…ŒìŠ¤íŠ¸ ë°©ë²•

1. **ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ ì—´ê¸°**
2. **Console íƒ­ í™•ì¸**
3. **ìì •(00:00) ëŒ€ê¸°**
4. **ë‹¤ìŒ ë¡œê·¸ í™•ì¸:**
   ```
   ğŸ”„ ìì • ê°ì§€! ë‚ ì§œê°€ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤: {ì´ì „ë‚ ì§œ: '2025-01-15', ìƒˆë‚ ì§œ: '2025-01-16'}
   ğŸ“Š DB ë¦¬ì…‹ ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì¤‘...
   âœ… DB ë¦¬ì…‹ ì™„ë£Œ! ëª¨ë“  today í†µê³„ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
   âœ… ìì • ë¦¬ì…‹ ì™„ë£Œ! ìƒˆë¡œìš´ ë‚ ì˜ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.
   ```
5. **ì°¨íŠ¸ í™•ì¸**: ëª¨ë“  ì‹œê°„ì´ 0ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•¨
6. **í†µê³„ í™•ì¸**: `today_api_calls`, `today_tasks`ê°€ 0ì´ì–´ì•¼ í•¨

## ë¬¸ì œ í•´ê²°

### Q: ìì •ì´ ì§€ë‚˜ë„ ë¦¬ì…‹ì´ ì•ˆ ë˜ëŠ” ê²½ìš°

1. **ë¸Œë¼ìš°ì € Console í™•ì¸**
   - ìì • ê°ì§€ ë¡œê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
   - ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

2. **DB í•¨ìˆ˜ í™•ì¸**
   ```sql
   SELECT pg_get_functiondef('reset_today_stats_for_all_agents'::regproc);
   ```

3. **RLS ì •ì±… í™•ì¸**
   - `authenticated` ì—­í• ì´ í•¨ìˆ˜ ì‹¤í–‰ ê¶Œí•œ ìˆëŠ”ì§€ í™•ì¸

### Q: Realtime ì—…ë°ì´íŠ¸ê°€ ì•ˆ ë˜ëŠ” ê²½ìš°

1. **WebSocket ì—°ê²° í™•ì¸**
   - Network íƒ­ â†’ WebSocket ì—°ê²° í™•ì¸
   - `SUBSCRIBED` ìƒíƒœì¸ì§€ í™•ì¸

2. **Realtime ì´ë²¤íŠ¸ í™•ì¸**
   - Network íƒ­ â†’ WebSocket â†’ Messages
   - `postgres_changes` ì´ë²¤íŠ¸ í™•ì¸
